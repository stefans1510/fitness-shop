<div mat-dialog-title class="flex items-center gap-2">
  <mat-icon>local_offer</mat-icon>
  <span>{{isEdit ? 'Edit' : 'Create'}} Coupon</span>
</div>

<form [formGroup]="couponForm" (ngSubmit)="onSubmit()">
  <mat-dialog-content class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Coupon Code -->
      <mat-form-field appearance="outline" class="col-span-full">
        <mat-label>Coupon Code</mat-label>
        <input matInput 
               formControlName="code" 
               placeholder="SAVE20"
               style="text-transform: uppercase;">
        <mat-hint>Enter letters and numbers</mat-hint>
        @if (isFieldInvalid('code')) {
          <mat-error>
            {{getErrorMessage('code')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline" class="col-span-full">
        <mat-label>Description</mat-label>
        <textarea matInput 
                  formControlName="description" 
                  rows="2"
                  placeholder="20% off on all products"></textarea>
        @if (isFieldInvalid('description')) {
          <mat-error>
            {{getErrorMessage('description')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Type -->
      <mat-form-field appearance="outline">
        <mat-label>Discount Type</mat-label>
        <mat-select formControlName="type">
          @for (type of couponTypes; track type.value) {
            <mat-option [value]="type.value">
              {{type.name}}
            </mat-option>
          }
        </mat-select>
        @if (isFieldInvalid('type')) {
          <mat-error>
            {{getErrorMessage('type')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Value -->
      <mat-form-field appearance="outline">
        <mat-label>Discount Value</mat-label>
        <input matInput 
               type="number" 
               formControlName="value" 
               [placeholder]="couponForm.get('type')?.value === 1 ? '20' : '10'"
               step="1">
        <span matSuffix class="m-2">{{getTypeLabel()}}</span>
        @if (couponForm.get('type')?.value === 1) {
          <mat-hint>Enter percentage (1-100)</mat-hint>
        }
        @if (couponForm.get('type')?.value === 2) {
          <mat-hint>Enter whole dollar amount</mat-hint>
        }
        @if (isFieldInvalid('value')) {
          <mat-error>
            {{getErrorMessage('value')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Minimum Order Amount -->
      <mat-form-field appearance="outline">
        <mat-label>Min Order Amount</mat-label>
        <input matInput 
               type="number" 
               formControlName="minimumOrderAmount" 
               placeholder="50.00"
               step="0.01">
        <span matPrefix class="m-2">$</span>
        <mat-hint>Leave empty for no minimum</mat-hint>
        @if (isFieldInvalid('minimumOrderAmount')) {
          <mat-error>
            {{getErrorMessage('minimumOrderAmount')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Maximum Discount Amount (for percentage coupons) -->
      @if (couponForm.get('type')?.value === 1) {
        <mat-form-field appearance="outline">
          <mat-label>Max Discount Amount</mat-label>
          <input matInput 
                 type="number" 
                 formControlName="maximumDiscountAmount" 
                 placeholder="100.00"
                 step="0.01">
          <span matPrefix class="m-2">$</span>
          <mat-hint>For percentage coupons</mat-hint>
          @if (isFieldInvalid('maximumDiscountAmount')) {
            <mat-error>
              {{getErrorMessage('maximumDiscountAmount')}}
            </mat-error>
          }
        </mat-form-field>
      }

      <!-- Valid From -->
      <mat-form-field appearance="outline">
        <mat-label>Valid From</mat-label>
        <input matInput 
               [matDatepicker]="fromPicker" 
               formControlName="validFrom">
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
        @if (isFieldInvalid('validFrom')) {
          <mat-error>
            {{getErrorMessage('validFrom')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Valid Until -->
      <mat-form-field appearance="outline">
        <mat-label>Valid Until</mat-label>
        <input matInput 
               [matDatepicker]="untilPicker" 
               formControlName="validUntil">
        <mat-datepicker-toggle matSuffix [for]="untilPicker"></mat-datepicker-toggle>
        <mat-datepicker #untilPicker></mat-datepicker>
        @if (isFieldInvalid('validUntil')) {
          <mat-error>
            {{getErrorMessage('validUntil')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Usage Limit -->
      <mat-form-field appearance="outline">
        <mat-label>Usage Limit (Optional)</mat-label>
        <input matInput 
               type="number" 
               formControlName="usageLimit" 
               placeholder="100"
               min="1">
        <mat-hint>Leave empty for unlimited usage</mat-hint>
        @if (isFieldInvalid('usageLimit')) {
          <mat-error>
            {{getErrorMessage('usageLimit')}}
          </mat-error>
        }
      </mat-form-field>

      <!-- Customer Only Checkbox -->
      <div class="col-span-full">
        <mat-checkbox formControlName="isCustomerOnly">
          <span class="ml-2">Regular Customers Only</span>
          <div class="text-sm text-gray-500 mt-1">
            This coupon will only be available to regular customers (not company users)
          </div>
        </mat-checkbox>
      </div>
    </div>

    <!-- Form Summary -->
    @if (couponForm.valid) {
      <div class="bg-gray-50 p-4 rounded-lg mt-6">
        <h4 class="font-semibold text-gray-700 mb-2">Coupon Preview</h4>
        <div class="text-sm space-y-1">
          <div><strong>Code:</strong> {{couponForm.get('code')?.value}}</div>
          <div><strong>Discount:</strong> 
            {{couponForm.get('type')?.value === 1 ? couponForm.get('value')?.value + '%' : '$' + couponForm.get('value')?.value}}
            {{couponForm.get('type')?.value === 1 ? ' off' : ' off'}}
          </div>
          @if (couponForm.get('minimumOrderAmount')?.value) {
            <div>
              <strong>Minimum Order:</strong> ${{couponForm.get('minimumOrderAmount')?.value}}
            </div>
          }
          @if (couponForm.get('usageLimit')?.value) {
            <div>
              <strong>Usage Limit:</strong> {{couponForm.get('usageLimit')?.value}} times
            </div>
          }
        </div>
      </div>
    }
  </mat-dialog-content>

  <mat-dialog-actions align="end" class="gap-2 p-4">
    <button mat-button type="button" (click)="onCancel()">
      Cancel
    </button>
    <button mat-flat-button 
            type="submit" 
            [disabled]="!couponForm.valid"
    >
      {{isEdit ? 'Update' : 'Create'}} Coupon
    </button>
  </mat-dialog-actions>
</form>