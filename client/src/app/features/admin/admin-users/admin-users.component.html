<div class="flex justify-between items-center mt-4 max-w-screen-2xl mx-auto">
    <h2 class="text-2xl font-semibold">User Management</h2>
    <div class="flex gap-4 items-center mr-4">
        <mat-form-field appearance="outline" class="w-48">
            <mat-label>Role Filter</mat-label>
            <mat-select [(ngModel)]="userParameters.role" (selectionChange)="onRoleFilterChange()">
                @for (role of roleFilterOptions; track role) {
                    <mat-option [value]="role === 'All' ? '' : role">{{role}}</mat-option>
                }
            </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-full max-w-xs">
            <mat-label>Search</mat-label>
            <input matInput [(ngModel)]="userParameters.search" (ngModelChange)="onSearch()" placeholder="Search by email or name" />
        </mat-form-field>
    </div>
</div>

<!-- Create Admin Form -->
@if (showCreateAdminForm) {
    <div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-l-4 border-blue-500 mb-6 mx-4 rounded-lg shadow-sm">
        <div class="max-w-2xl mx-auto">
            <div class="flex items-center mb-6">
                <div>
                    <h3 class="text-xl font-semibold text-gray-800">Create New Admin User</h3>
                    <p class="text-sm text-gray-600 mt-1">Add a new administrator to the system</p>
                </div>
            </div>

            <!-- Form Container -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <form [formGroup]="adminForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <app-text-input label="Email Address" formControlName="email" type="email" />
                    </div>
                    
                    <app-text-input label="First Name" formControlName="firstName" />
                    
                    <app-text-input label="Last Name" formControlName="lastName" />
                    
                    <div class="md:col-span-2">
                        <app-text-input label="Password" formControlName="password" type="password" />
                    </div>
                </form>
                
                @if (validationErrors) {
                    <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start">
                            <mat-icon class="text-red-500 mr-2 mt-0.5 text-lg">error_outline</mat-icon>
                            <div>
                                <h4 class="text-sm font-medium text-red-800 mb-2">Please correct the following errors:</h4>
                                <ul class="list-disc list-inside text-sm text-red-600 space-y-1">
                                    @for (error of validationErrors; track $index) {
                                        <li>{{error}}</li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-100">
                    <button 
                        mat-stroked-button 
                        (click)="onCancelAdminForm()" 
                        type="button"
                        class="px-6">
                        Cancel
                    </button>
                    @if (createAdminLoading) {
                        <button 
                            mat-raised-button 
                            color="primary" 
                            [disabled]="true"
                            type="button"
                            class="px-6 min-w-[140px]">
                            <mat-icon class="animate-spin mr-2">refresh</mat-icon>
                            Creating...
                        </button>
                    } @else {
                        <button 
                            mat-raised-button 
                            color="primary" 
                            (click)="onSubmitAdminForm()" 
                            [disabled]="adminForm.invalid"
                            type="button"
                            class="px-6 min-w-[140px]">
                            <mat-icon class="mr-2">person_add</mat-icon>
                            Create Admin
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

<div class="p-4">
    @if (loading) {
        <div class="flex justify-center items-center p-8">
            <mat-icon class="animate-spin">refresh</mat-icon>
            <span class="ml-2">Loading users...</span>
        </div>
    } @else {
        <div class="mat-elevation-z2 border border-gray-200 rounded-lg shadow-sm overflow-hidden">
            <table mat-table [dataSource]="users" class="bg-white w-full rounded-lg">
                <ng-container matColumnDef="email">
                    <th mat-header-cell *matHeaderCellDef class="bg-gray-50 text-gray-700 font-semibold text-sm border-b border-gray-200">Email</th>
                    <td mat-cell *matCellDef="let user" class="border-b border-gray-100 py-4">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-900">{{user.email}}</span>
                        </div>
                    </td>
                </ng-container>
                <ng-container matColumnDef="firstName">
                    <th mat-header-cell *matHeaderCellDef class="bg-gray-50 text-gray-700 font-semibold text-sm border-b border-gray-200">Name</th>
                    <td mat-cell *matCellDef="let user" class="border-b border-gray-100 py-4 text-gray-800">{{user.firstName || '-'}}</td>
                </ng-container>
                <ng-container matColumnDef="lastName">
                    <th mat-header-cell *matHeaderCellDef class="bg-gray-50 text-gray-700 font-semibold text-sm border-b border-gray-200">Surname</th>
                    <td mat-cell *matCellDef="let user" class="border-b border-gray-100 py-4 text-gray-800">{{user.lastName || '-'}}</td>
                </ng-container>
                <ng-container matColumnDef="userType">
                    <th mat-header-cell *matHeaderCellDef class="bg-gray-50 text-gray-700 font-semibold text-sm border-b border-gray-200">User Type</th>
                    <td mat-cell *matCellDef="let user" class="border-b border-gray-100 py-4">
                        <div class="flex flex-col gap-1">
                            <div class="flex gap-1 flex-wrap">
                                @for (role of user.roles; track role) {
                                    <span [class]="getRoleClass(role)">
                                        <mat-icon class="text-sm">{{getRoleIcon(role)}}</mat-icon>
                                        {{role}}
                                    </span>
                                }
                            </div>
                            @if (user.isCompanyUser && user.companyCode) {
                                <div class="text-xs text-gray-600 mt-1">
                                    <mat-icon class="text-xs mr-1">business</mat-icon>
                                    Code: {{user.companyCode}}
                                </div>
                            }
                        </div>
                    </td>
                </ng-container>
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="bg-gray-50 text-gray-700 font-semibold text-sm border-b border-gray-200">Actions</th>
                    <td mat-cell *matCellDef="let user" class="border-b border-gray-100 py-4">
                        <button 
                            (click)="deleteUser(user)"
                            matTooltip="Delete" 
                            mat-icon-button
                            class="hover:bg-red-50">
                            <mat-icon class="text-red-600">cancel</mat-icon>
                        </button>
                    </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50 transition-colors"></tr>
            </table>
            <mat-paginator
                [pageSizeOptions]="[5, 10, 20]"
                [length]="pagination?.count || 0"
                [pageSize]="userParameters.pageSize"
                [pageIndex]="userParameters.pageIndex - 1"
                (page)="onPageChange($event)"
                showFirstLastButtons 
                class="bg-gray-50 border-t border-gray-200">
            </mat-paginator>
        </div>

        <!-- No Users Message -->
        @if (users.length === 0 && !loading) {
            <div class="text-center py-12">
                <mat-icon class="text-gray-400 text-6xl mb-4">people_outline</mat-icon>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No users found</h3>
                <p class="text-gray-500">
                    @if (userParameters.search || userParameters.role) {
                        Try adjusting your search criteria or filters
                    } @else {
                        No users have been registered yet
                    }
                </p>
            </div>
        }
    }
</div>

<button mat-raised-button color="primary" (click)="openCreateAdminDialog()" 
    class="flex items-center float-end mr-4 min-w-[180px] whitespace-nowrap">
    <mat-icon class="mr-2">{{showCreateAdminForm ? 'close' : 'person_add'}}</mat-icon>
    {{showCreateAdminForm ? 'Cancel' : 'Create Admin User'}}
</button>
